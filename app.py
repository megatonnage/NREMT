import streamlit as stâ€¨import jsonâ€¨â€¨# --- Page Configuration ---â€¨st.set_page_config(â€¨Â  Â  page_title="EMT Scenario Simulator",â€¨Â  Â  page_icon="ğŸš‘",â€¨Â  Â  layout="centered"â€¨)â€¨â€¨# --- State Management ---â€¨# Streamlit's session state is used to store variables that persist between user interactions.â€¨# We initialize our needed variables here if they don't already exist.â€¨if 'screen' not in st.session_state:â€¨Â  Â  st.session_state.screen = 'main_menu'â€¨if 'scenario_library' not in st.session_state:â€¨Â  Â  st.session_state.scenario_library = Noneâ€¨if 'current_scenario' not in st.session_state:â€¨Â  Â  st.session_state.current_scenario = Noneâ€¨if 'current_node' not in st.session_state:â€¨Â  Â  st.session_state.current_node = 'start'â€¨if 'feedback_log' not in st.session_state:â€¨Â  Â  st.session_state.feedback_log = []â€¨â€¨â€¨# --- Core Functions ---â€¨â€¨@st.cache_data # Cache the data so it's not reloaded on every interactionâ€¨def load_scenario_data(uploaded_file):â€¨Â  Â  """Loads scenario data from an uploaded JSON file."""â€¨Â  Â  if uploaded_file is not None:â€¨Â  Â  Â  Â  try:â€¨Â  Â  Â  Â  Â  Â  return json.load(uploaded_file)â€¨Â  Â  Â  Â  except json.JSONDecodeError:â€¨Â  Â  Â  Â  Â  Â  st.error("Invalid JSON file. Please upload a correctly formatted scenario file.")â€¨Â  Â  Â  Â  Â  Â  return Noneâ€¨Â  Â  return Noneâ€¨â€¨def start_scenario(scenario_key):â€¨Â  Â  """Callback function to start a selected scenario."""â€¨Â  Â  st.session_state.current_scenario = scenario_keyâ€¨Â  Â  st.session_state.current_node = 'start'â€¨Â  Â  st.session_state.feedback_log = []â€¨Â  Â  st.session_state.screen = 'in_scenario' # Switch to the scenario viewâ€¨â€¨def make_choice(target, feedback):â€¨Â  Â  """Callback function when a user makes a decision."""â€¨Â  Â  st.session_state.feedback_log.append(feedback)â€¨Â  Â  st.session_state.current_node = targetâ€¨Â  Â  â€¨def go_to_debrief():â€¨Â  Â  """Switches to the debrief screen."""â€¨Â  Â  st.session_state.screen = 'debrief'â€¨â€¨def back_to_menu():â€¨Â  Â  """Resets state and returns to the main menu."""â€¨Â  Â  st.session_state.screen = 'main_menu'â€¨Â  Â  st.session_state.current_scenario = Noneâ€¨Â  Â  st.session_state.current_node = 'start'â€¨Â  Â  st.session_state.feedback_log = []â€¨â€¨# --- UI Rendering ---â€¨â€¨def render_vitals(vitals_dict):â€¨Â  Â  """Renders the patient vitals in a grid format."""â€¨Â  Â  st.subheader("Patient Vitals")â€¨Â  Â  cols = st.columns(3) # Create 3 columns for a tidy layoutâ€¨Â  Â  col_index = 0â€¨Â  Â  for key, value in vitals_dict.items():â€¨Â  Â  Â  Â  with cols[col_index]:â€¨Â  Â  Â  Â  Â  Â  st.metric(label=key, value=value)â€¨Â  Â  Â  Â  col_index = (col_index + 1) % 3â€¨â€¨def render_main_menu():â€¨Â  Â  """Displays the file uploader and scenario selection menu."""â€¨Â  Â  st.title("EMT Scenario Library ğŸš‘")â€¨Â  Â  st.markdown("Upload a `scenarios.json` file to begin. You can create your own library using the provided sample file as a template.")â€¨â€¨Â  Â  uploaded_file = st.file_uploader("Choose a scenario file", type="json")â€¨Â  Â  â€¨Â  Â  if uploaded_file:â€¨Â  Â  Â  Â  st.session_state.scenario_library = load_scenario_data(uploaded_file)â€¨â€¨Â  Â  if st.session_state.scenario_library:â€¨Â  Â  Â  Â  st.header("Select a Scenario")â€¨Â  Â  Â  Â  for key, scenario_data in st.session_state.scenario_library.items():â€¨Â  Â  Â  Â  Â  Â  title = scenario_data.get("title", "Untitled Scenario")â€¨Â  Â  Â  Â  Â  Â  # The on_click callback with args is the key to starting the correct scenarioâ€¨Â  Â  Â  Â  Â  Â  st.button(title, on_click=start_scenario, args=(key,), use_container_width=True)â€¨â€¨def render_scenario():â€¨Â  Â  """Displays the active scenario, vitals, and choices."""â€¨Â  Â  scenario_data = st.session_state.scenario_library[st.session_state.current_scenario]â€¨Â  Â  node_data = scenario_data[st.session_state.current_node]â€¨â€¨Â  Â  st.title(scenario_data.get("title", "NREMT Scenario"))â€¨Â  Â  st.divider()â€¨â€¨Â  Â  # Display scenario text and vitalsâ€¨Â  Â  st.markdown(node_data.get("text", ""), unsafe_allow_html=True)â€¨Â  Â  render_vitals(node_data.get("vitals", {}))â€¨Â  Â  st.divider()â€¨â€¨Â  Â  # Check if this node is the end of a scenario branchâ€¨Â  Â  if node_data.get("is_end", False):â€¨Â  Â  Â  Â  # Add the final feedback and switch to the debrief screenâ€¨Â  Â  Â  Â  if "feedback" in node_data:â€¨Â  Â  Â  Â  Â  Â  st.session_state.feedback_log.append(node_data["feedback"])â€¨Â  Â  Â  Â  st.warning(node_data.get("question", "Scenario Ended."))â€¨Â  Â  Â  Â  st.button("View Debrief", on_click=go_to_debrief, use_container_width=True, type="primary")â€¨Â  Â  else:â€¨Â  Â  Â  Â  # Display the question and choice buttonsâ€¨Â  Â  Â  Â  st.subheader(node_data.get("question", "What do you do next?"))â€¨Â  Â  Â  Â  for choice in node_data.get("choices", []):â€¨Â  Â  Â  Â  Â  Â  st.button(â€¨Â  Â  Â  Â  Â  Â  Â  Â  choice["text"],â€¨Â  Â  Â  Â  Â  Â  Â  Â  on_click=make_choice,â€¨Â  Â  Â  Â  Â  Â  Â  Â  args=(choice["target"], choice["feedback"]),â€¨Â  Â  Â  Â  Â  Â  Â  Â  use_container_width=Trueâ€¨Â  Â  Â  Â  Â  Â  )â€¨â€¨def render_debrief():â€¨Â  Â  """Displays the final feedback log after a scenario is completed."""â€¨Â  Â  st.title("Scenario Debrief")â€¨Â  Â  st.divider()â€¨â€¨Â  Â  for item in st.session_state.feedback_log:â€¨Â  Â  Â  Â  feedback_type = item.get("type", "neutral")â€¨Â  Â  Â  Â  text = item.get("text", "")â€¨Â  Â  Â  Â  â€¨Â  Â  Â  Â  if feedback_type == 'good':â€¨Â  Â  Â  Â  Â  Â  st.success(f"âœ… **Good Choice:** {text}")â€¨Â  Â  Â  Â  elif feedback_type == 'bad':â€¨Â  Â  Â  Â  Â  Â  st.error(f"âŒ **Incorrect Choice:** {text}")â€¨Â  Â  Â  Â  else:â€¨Â  Â  Â  Â  Â  Â  st.warning(f"âš ï¸ **Note:** {text}")â€¨â€¨Â  Â  st.divider()â€¨Â  Â  st.button("Back to Main Menu", on_click=back_to_menu, use_container_width=True, type="primary")â€¨â€¨# --- Main Application Router ---â€¨# This block checks the 'screen' state and calls the appropriate render function.â€¨if st.session_state.screen == 'main_menu':â€¨Â  Â  render_main_menu()â€¨elif st.session_state.screen == 'in_scenario':â€¨Â  Â  render_scenario()â€¨elif st.session_state.screen == 'debrief':â€¨Â  Â  render_debrief()â€¨
